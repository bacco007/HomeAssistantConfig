---
type: vertical-stack
cards:
  - type: custom:bubble-card
    card_type: separator
    name: Birthdays & Anniversaries
    icon: mdi:gift-outline
    styles: |-
      .bubble-line {
        background: var(--ha-card-background);
        opacity: 1;
        }
  - type: custom:auto-entities
    unique: true
    show_empty: false
    card:
      type: custom:layout-card
      layout_type: masonry
    card_param: cards
    filter:
      template: |
        {%- for s in expand(integration_entities('anniversaries'))
            | selectattr('state', 'is_number')
            | rejectattr('entity_id', 'search', '^sensor\.anniversary_days')
            | rejectattr('entity_id', 'search', 'sensor.anniversary_days*')
            | rejectattr('entity_id', 'search', 'sensor.anniversary_myworkbirthday')
            | sort(attribute='attributes.weeks_remaining', reverse=false)
        -%}
          {%- set e = s.entity_id -%}
          {%- set fname = state_attr(e, 'friendly_name') or 'Birthday' -%}
          {%- set name = 'Thomas' if fname == 'My Birthday' else fname.split("'")[0] -%}
          {%- set years = state_attr(e, 'years_at_anniversary') | int(0) -%}
          {%- set days_left = states(e) | int(0) -%}
          {%- set current_date = now() -%}
          {%- set start_of_year = current_date.replace(month=1, day=1, hour=0, minute=0, second=0, microsecond=0) -%}
          {%- set next_dt = as_datetime(state_attr(e,'next_date')) if state_attr(e,'next_date') else (now() + timedelta(days=1)) -%}
        
          {{
            {
              "type": "custom:timeflow-card",
              "title": name ~ "â€™s " ~ years ~ (
                'st' if years % 10 == 1 and years % 100 != 11 else
                'nd' if years % 10 == 2 and years % 100 != 12 else
                'rd' if years % 10 == 3 and years % 100 != 13 else
                'th'
              ) ~ " Birthday",
              "target_date": next_dt.replace(tzinfo=None).isoformat(),
              "creation_date": start_of_year.isoformat(),
              "show_days": true,
              "show_hours": false,
              "show_minutes": false,
              "show_seconds": false,
              "icon": "mdi:gift",
              "text_color": (
                "#FF6B6B" if days_left == 0 else
                "#4ECDC4" if days_left <= 7 else
                "#45B7D1" if days_left <= 30 else
                "#96CEB4"
              ),
              "background_color": "#2C3150",
              "progress_color": "#D0CFCF",
              "aspect_ratio": "4/2",
              "stroke_width": 12,
              "compact_format": false,
              "style": "classic-compact",
              "card_mod": {
                "style": "ha-card .title {font-size: 1rem;} ha-card .subtitle {font-size: 1rem;}"
              }
            }
          }},
        {%- endfor -%}

    sort:
      method: state
      numeric: true

